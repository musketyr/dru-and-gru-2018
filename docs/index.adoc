= Dru and Gru Workshop
Vladimír Oraný <https://github.com/musketyr[icon:github[] @musketyr]>

== Getting Started

This workshop will learn you how to use https://agorapulse.github.io/dru/[Dru] for preparing test data and https://agorapulse.github.io/gru/[Gru]
for testing HTTP backends. Although I've made the best effort to keep this workshop self-contained, some of the exercise may need further reading of the following documentation pages:

 * http://docs.grails.org/latest/[Grails 3]
 * http://spockframework.org/spock/docs/1.1/index.html[Spock]
 * https://agorapulse.github.io/dru/[Dru]
 * https://agorapulse.github.io/gru/[Gru]

=== Software Requirements

To get started you need to have installed following:

 * http://www.oracle.com/technetwork/java/javase/downloads/jdk8-downloads-2133151.html[Java Development Kit 8]

Project is built using https://gradle.org/[Gradle] build tool but it's using https://docs.gradle.org/current/userguide/gradle_wrapper.html[Gradle Wrapper]
so you are not required to install it manually nor you don't have to be afraid of version clash.

You can use IDE of your choice but https://www.jetbrains.com/idea/[IntelliJ IDEA] provides so far the best
Gradle and Groovy integration even in the free Community version and it will be used in live coding sessions during
the workshop. Import the project as Gradle project get the best developer experience.

=== Getting Started

To get started download link:archives/gritter.zip[exercise project archive file] and unzip it. Feel free to ignore
the client part of the application. Run following command to get all dependencies downloaded:

```
./gradlew dependencies
```


=== Exercise 1: HTTP Testing

image::https://s3.amazonaws.com/media-p.slid.es/uploads/36318/images/4671552/Sni%CC%81mek_obrazovky_2018-03-06_v_9.13.01.png[Gritter App]
____

You have been hired by https://trafficscotland.org/wintergritterinfo/[Traffic Scotland] to finish a Grails application
which was left by a developer who was fired from the company. It's called Gritter (Grails + Twitter) and it purpose is to
share text statuses published by http://scotgov.maps.arcgis.com/apps/webappviewer/index.html?id=2de764a9303848ffb9a4cac0bd0b1aab[drivers of gritters].

You don't want to be responsible or someone's other mess so first thing you want to do in the new job is to cover the existing
code with tests as there are currently no tests in the project.

As a first task you decided to create a integration tests which verifies that new status can be written.
____


==== Gru HTTP Testing

Gru provides test support for any HTTP backend, not just Grails. We can use https://agorapulse.github.io/gru/#_http[Gru HTTP] client
inside Grails integration test easily with following setup.

To get started, create new specification class in `server/src/integration-test/groovy/gritter/StatusControllerIntegrationSpec.groovy` with following content.

[source,groovy,indent=0,options="nowrap"]
.Integration Specification Skeleton
----
include::../server/src/integration-test/groovy/gritter/StatusControllerIntegrationSpec.groovy[tag=header]
include::../server/src/integration-test/groovy/gritter/StatusControllerIntegrationSpec.groovy[tag=footer]
----
<1> Running integration tests requires `@Integration` annotation to be applied on the class and the file be located under `src/integration-test` folder
<2> Application in integration test environment runs on random port which can be injected into the test
<3> Creates new `Gru` rule with `Http` client
<4> Sets the base URL to the address of the current application under test

[source,groovy,indent=0,options="nowrap"]
.Create Status Test Method
----
include::../server/src/integration-test/groovy/gritter/StatusControllerIntegrationSpec.groovy[tag=create-status]
----
<1> Just a regular Spock feature method to test status creation
<2> Starts Gru test definition
<3> Tests `POST` to URI `/status`
<4> Adds `User` header to the request
<5> Loads the request body from file `server/src/test/resources/gritter/StatusControllerIntegrationSpec/newStatusRequest.json`
<6> Expect clause adds verification to the test
<7> Asserts that the returned status is `CREATED`
<9> Reference file which is created automatically in `server/src/test/resources/gritter/StatusControllerIntegrationSpec` directory from the actual payload if not present

If you run the test for a first time, both `newStatusRequest.json` and `newStatusResponse.json` are created automatically.

Replace the content of `newStatusRequest.json` file with following:

[source,json]
.newStatusRequest.json
----
include::../server/src/test/resources/gritter/StatusControllerIntegrationSpec/newStatusRequest.json[]
----

Delete the content of `newStatusResponse.json` and run the test again. New content of `newStatusResponse.json` should get generated:

[source,json]
----
{
  "id": 201,
  "created": "2018-05-28T15:08:09Z",
  "text": "No Snow here, let's take a break!",
  "user": {
    "id": 1,
    "username": "John Sno"
  },
  "engagementsCount": 0,
  "engagements": []
}
----

If you run the test again, the test will still not pass as the ids and `created` timestamp changes
on each call. If you read  https://agorapulse.github.io/gru/#_json_response[Json Response] documentation you find out how to change the generated fixture to allow variable content.
You can use JSON Unit placeholders.

[source,json]
.newStatusResponse.json
----
include::../server/src/test/resources/gritter/StatusControllerIntegrationSpec/newStatusResponse.json[]
----

=== Exercise 2: Grails Controller Testing
____
You have created your first integration test but you are not happy. You were taught that integration tests are
unnecessarily slow and you should try to write unit test whereever it is possible. Try to rewrite the create status test
as a unit test. Keep the original test for comparison. Ensure that expected controller action is called during the test.
____

Unit tests no longer reside in `src/integration-test/groovy` but they are located in general `src/test/groovy` folder.
Every Grails's controller test must implement `grails.testing.web.controllers.ControllerUnitTest` trait. To setup `Gru`
with `Grails` client you should supply the `UrlMappings` describing the mapped URL and any interceptor on which the controller's logic rely.


[source,groovy,indent=0,options="nowrap"]
.Gru Grails Setup
----
include::../server/src/test/groovy/gritter/StatusControllerSpec.groovy[tag=gru-setup]
----

TIP: Use `executes` method inside Gru's HTTP method call definition to verify which controller's method has been executed.


=== Exercise 3: Preparing Testing Data

____
You have finished your first Gru's controller unit test and you want to create another one for `index` action but you
lack the required data. It looks you should be able to use Dru to preload data for the controller test to get consistent
responses from the controller unit test.
____

==== Using Dru to Preload Data

Dru allows you to map existing data such as rendered JSON back to original entities. From running application you can
easily obtain the data in JSON format using HTTP client such as `cURL` or by simply opening the endpoint URL in the browser.


[source,json,indent=0,options="nowrap"]
.item.json (from Dru documentation)
----
{
  "id": "050e4fcf-158d-4f44-9b8b-a6ba6809982e",
  "name": "PX-41",
  "description": "The PX-41 is a very dangerous mutator engineered in the top secret PX-Labs, located in the Arctic Circle. It is capable of turning any living things in the world into a purple, furry, indestructible, mindless, killing machine that is so dangerous that it can destroy anything in its path.",
  "tags": [
    "mutator",
    "monsters",
    "superpowers"
  ]
}
----

Once you save the JSON file in convenient location which is similar to `src/test/resources/package/structure/follows/NameOfTheSpec`

you are able to import the data using Dru.

[source,groovy,indent=0,options="nowrap"]
.Load Entities from JSON using Dru
----
@Rule Dru dru = Dru.plan {                                                      // <1>
    from ('item.json') {                                                        // <2>
        map { to Item }                                                         // <3>
    }
}

void setup() {
    dru.load()                                                                  // <4>
}
----
<1> Create new dru instance
<2> Load data from `item.json` (e.g. `src/test/resources/gritter/StatusControllerSpec/item.json`)
<3> Map every element is mapped to given class `Item`
<4> Loads the entities into GORM mock datastore before each test


If you run the Gritter server with command

----
./gradlew :server:bootRun
----

You will be able to fetch the list of statuses with cURL

----
curl http://localhost:8080/status > statuses.json
----

Save the file to convenient location and load it into your `StatusControllerSpec` using Dru. Use the loaded entities
in a test which covers `index` controller method.

TIP: You need to implement `grails.testing.gorm.DataTest` if your test wants to work with GORM entities.

TIP: Ensure you have used every information from the JSON using `dru.report`. See https://agorapulse.github.io/dru/#_ignoring_properties[related section in the documentation].

=== Exercise 4: Sharing Test Data

____
While you were wandering through the code of the application you have discovered method to fetch the top statuses for
given time period inside `StatusService`. You would like to cover this method with test but you will need the data you've
already defined in `StatusControllerSpec`.
____

==== Prepared Data Sets

You can easily reuse existing data set by creating a prepared data set:

[source,groovy,indent=0,options="nowrap"]
.Prepared Data Set
----
static PreparedDataSet tasks = Dru.prepare {
    from 'tasks.json', {
        map {
            to Task
        }
    }
}
----

Later on you can use the data set inside your test class by including it:

[source,groovy,indent=0,options="nowrap"]
.Include Prepared Data Set
----
@Rule Dru dru = Dru.plan {
    include OtherSpec.tasks
}
----

Create a `StatusServiceSpec` to test `StatusService` class and let it reuse the statuses data set declared in `StatusContollerSpec`.
Use the loaded data to test `StatusService.findTopStatuses` method.
